<!-- Tilt_tailsitter Airframe File
  		* Autopilot: 	PX4FMU 4.0 aka Pixracer v1.0 R15
		* GPS:			Ublox M8N
-->

<airframe name="tilt_tailsitter test">

<firmware name="rotorcraft">
    <!-- ****************** Autopilot Target ******************* -->
    <target name="ap" board="px4fmu_4.0_chibios">
      <define name="FLASH_MODE" value="PX4_BOOTLOADER"/>
      <configure name="PERIODIC_FREQUENCY" value="500"/>

      <!-- <module name="radio_control" type="datalink"/>-->
      <module name="radio_control" type="sbus">
        <define name="RADIO_CONTROL_NB_CHANNEL" value="16"/>
        <define name="RADIO_KILL_SWITCH" value="5"/>
        <define name="RADIO_KILL" value="5"/>
        <!-- <define name="RADIO_PIVOT_SWITCH" value="6"/> -->
      </module>

        <module name="airspeed" type="ms45xx_i2c">
        <define name="USE_I2C1" value="TRUE"/><!-- 4525D5AI 001D 2126 010417094 -->
        <define name="MS45XX_I2C_DEV" value="i2c1"/>
        <!--<define name="MS45XX_PRESSURE_TYPE" value="0"/> --><!--description="Pressure Differential or Gauge, default is Differential">-->
        <define name="MS45XX_PRESSURE_RANGE" value="1" /><!-- description="pressure range in psi (default: 1)"-->
        <define name="MS45XX_OUTPUT_TYPE" value="0"/> <!--description="set to 0 for output type A, to 1 for output type B (default: type A)"/>-->
        <define name="MS45XX_SYNC_SEND" value="FALSE" /> <!--description="flag to enable sending every new measurement via telemetry (default:FALSE)-->
        <define name="MS45XX_PRESSURE_SCALE" value="1.052"/> <!--description="pressure scaling factor to convert raw output to Pa (default: set according to pressure range and output type according to datasheet)"-->
        <define name="MS45XX_PRESSURE_OFFSET" value="8503.84" /><!-- 8507.3 description="pressure offset in Pa (default: set according to pressure range and output type according to datasheet)-->
<!--        <define name="MS45XX_AIRSPEED_SCALE" value="1.6327"/> &lt;!&ndash;description="quadratic scale factor to convert differential pressure to airspeed"&ndash;&gt;-->
        <define name="MS45XX_LOWPASS_TAU" value="0.2"/> <!--description="Time constant for second order Butterworth low pass filter"-->
        <define name="USE_AIRSPEED_MS45XX" value="TRUE"/> <!--description="Set airspeed in state interface for this sensor" -->
      </module>
    </target>

 <!-- ****************** Simulation Target ****************** -->
    <target name="nps"          board="pc">
      <module name="fdm" type="jsbsim"/>
      <module name="udp"/>
      <module name="radio_control" type="datalink">
      <define name="RADIO_PIVOT_SWITCH" value="0"/>
      </module>
      <module name="logger_file">
        <define name="FILE_LOGGER_PATH" value="/data/localhome/ziqingma/Documents/paparazzi/Logs/SIM_logs"/>
      </module>

      <!--Switch advanced INDI scheduling functions on or off-->
      <!--Take the mode channel for simulation-->
      <define name="INDI_FUNCTIONS_RC_CHANNEL" value="4"/>
      <define name="USE_PIVOT_SWITCH" value="TRUE"/>
    </target>

<!-- ****************** Common to both ********************* -->
    <module name="gps" type="ubx_ucenter"/>
    
    <module name="tlsf"/>
    <module name="pprzlog"/>
    <module name="logger" type="sd_chibios"/>
    <module name="flight_recorder"/>
    <define name="SDLOG_AUTO_FLUSH_PERIOD" value="1" unit="s"/>

    <module name="actuators" type="pwm">
      <define name="SERVO_HZ" value="400"/>
      <!--define name="USE_SERVOS_7AND8"/-->
    </module>

    <module name="sys_mon"/>

    <module name="guidance"      type="indi_hybrid">
      <define name="GUIDANCE_INDI_RC_DEBUG" value="FALSE"/>
      <define name="GUIDANCE_INDI_POS_GAIN" value="0.8"/>
      <define name="GUIDANCE_INDI_SPEED_GAIN" value="2.0"/>
      <define name="GUIDANCE_INDI_POS_GAINZ" value="1.5"/>
      <define name="GUIDANCE_INDI_SPEED_GAINZ" value="2.8"/>
      <define name="GUIDANCE_INDI_PITCH_LIFT_EFF" value="0.12"/>
      <define name="GUIDANCE_INDI_PITCH_EFF_SCALING" value="1.0"/>
      <define name="GUIDANCE_H_REF_MAX_SPEED" value="18.0"/> <!--not used-->
      <define name="GUIDANCE_INDI_MIN_THROTTLE" value="3000"/>
      <define name="GUIDANCE_INDI_MIN_THROTTLE_FWD" value="1000"/>
      <define name="GUIDANCE_INDI_MAX_AIRSPEED" value="15.0"/>
      <define name="GUIDANCE_HEADING_IS_FREE" value="FALSE"/> <!--heading can not be set by navigation-->
      <define name="GUIDANCE_INDI_HEADING_BANK_GAIN" value="15.0"/>
      <!--<define name="KNIFE_EDGE_TEST" value="TRUE"/>-->
    </module>

    <!--    <module name="telemetry" type="transparent"/>				-->
    <!--<module name="motor_mixing"/>-->
    <module name="telemetry" type="transparent">
      <configure name="MODEM_PORT" value="UART3"/>
      <configure name="MODEM_BAUD" value="B57600"/>
    </module>

    <module name="imu" type="mpu9250_spi">
      <configure name="IMU_MPU9250_SPI_DEV" value="spi1"/>
      <configure name="IMU_MPU9250_SPI_SLAVE_IDX" value="SPI_SLAVE2"/>
      <define name="IMU_MPU9250_READ_MAG" value="TRUE"/>
    </module>

    <!--<module name="servo_tester"/>-->

    <module name="air_data">
      <define name="USE_AIRSPEED_AIR_DATA" value="TRUE"/>
    </module>

    <module name="gps" type="ublox">
      <!-- <configure name="GPS_BAUD" value="B57600"/> -->
    </module>

   <module name="stabilization" type="indi">
      <configure name="INDI_NUM_ACT" value="6"/>
    </module>

    <module name="ins" type="ekf2"/>
    <!--<module name="ins" type="float_invariant">
      <define name="INS_PROPAGATE_FREQUENCY" value="500"/>
    <define name="INS_FINV_MAG_ID" value="MAG_HMC58XX_SENDER_ID"/>
    </module>-->

    <!-- Control effectiveness calculator that calculates
    	 the control effectiveness matrix on the fly	 -->
    <module name="ctrl_effectiveness_calculator"/>
    <!-- ******************************************************* -->
    <!--<module name="static_wind_tunnel">
      <define name="TAILSITTER_WIND_TUNNEL" value="FALSE"/>
      <define name="TAILSITTER_WIND_TUNNEL_NO_PROP" value="TRUE"/>
    </module>-->


  </firmware>
	  	 
  <servos driver="Pwm">
    <servo name="TILT_LEFT"  no="0" min="2160" neutral="1460" max="760"/>
    <servo name="TILT_RIGHT" no="1" min="750" neutral="1500" max="2250"/> <!--neutral 1515-->
    <!--<servo name="ELEVON_RIGHT"  no="1" min="820" neutral="1520" max="2220"/>-->
    <servo name="RM" no="2" min="1000" neutral="1100" max="2000"/>
    <servo name="LM" no="3" min="1000" neutral="1100" max="2000"/>
    <servo name="ELE_LEFT"  no="4" min="690" neutral="1440" max="2190"/> <!--neutral 1526-->
    <servo name="ELE_RIGHT"  no="5" min="770" neutral="1520" max="2270"/>
    <!--<servo name="SERVO_TEST" no="4" min="1000" neutral="1500" max="2000"/>-->
  </servos>

  <commands>
    <axis name="PITCH"  failsafe_value="0"/>
    <axis name="ROLL"   failsafe_value="0"/>
    <axis name="YAW"    failsafe_value="0"/>
    <axis name="THRUST" failsafe_value="0"/>
  </commands>

  <command_laws>
    <set servo="TILT_LEFT"     value="autopilot.motors_on ? actuators_pprz[0] : 0"/>
    <set servo="TILT_RIGHT"    value="autopilot.motors_on ? actuators_pprz[1] : 0"/>
    <set servo="RM"              value="autopilot.motors_on ? actuators_pprz[2] : -MAX_PPRZ"/>
    <set servo="LM"              value="autopilot.motors_on ? actuators_pprz[3] : -MAX_PPRZ"/>
    <set servo="ELE_LEFT"              value="autopilot.motors_on ? actuators_pprz[4] : 0"/>
    <set servo="ELE_RIGHT"              value="autopilot.motors_on ? actuators_pprz[5] : 0"/>
    <!-- <call fun="motor_mixing_run(autopilot_get_motors_on(),FALSE,values)"/>
    <set servo="TILT_LEFT"  value="wt_data.run ? wt_data.commands[0] : 0"/>
    <set servo="TILT_RIGHT"  value="wt_data.run ? wt_data.commands[1] : 0"/>
    <set servo="RM"  value="wt_data.run ? wt_data.commands[2] : -MAX_PPRZ"/>
    <set servo="LM"  value="wt_data.run ? wt_data.commands[3] : -MAX_PPRZ"/>
    <set servo="ELE_LEFT"  value="wt_data.run ? wt_data.commands[4] : 0"/>
    <set servo="ELE_RIGHT"  value="wt_data.run ? wt_data.commands[5] : 0"/>-->
  </command_laws>

  <!--<section name="MIXING" prefix="MOTOR_MIXING_">
    <define name="TRIM_ROLL" value="0"/>
    <define name="TRIM_PITCH" value="0"/>
    <define name="TRIM_YAW" value="0"/>
    <define name="NB_MOTOR" value="4"/>
    <define name="SCALE" value="256"/>
    <define name="PITCH_COEF"  value="{ -256, -256,  256,  256 }"/>
    <define name="ROLL_COEF"   value="{  256, -256,  256, -256 }"/>
    <define name="YAW_COEF"    value="{ -256,  256,  128, -128 }"/>
    <define name="THRUST_COEF" value="{  256,  256,  256,  256 }"/>
    <define name="PITCH_COEF"  value="{ 0, 0, 0, 0 }"/>
    <define name="ROLL_COEF"   value="{ 0, 0, 0, 0 }"/>
    <define name="YAW_COEF"    value="{ 0, 0, 0, 0 }"/>
    <define name="THRUST_COEF" value="{ 0, 0, 0, 0 }"/>
  </section>-->

  <!--<section name="WINDTUNNEL" prefix="STATIC_WIND_TUNNEL_">
    <define name="MEASUREMENT_TIME" value="10.0" description="Time to measure each conidion [seconds]"/>
  </section>-->

  <section name="IMU" prefix="IMU_">
    <!-- IMU calibration, make sure to calibrate the IMU properly before flight, see the wiki for more info-->
    <!--<define name="MAG_X_NEUTRAL" value="-37"/>-->
    <!--<define name="MAG_Y_NEUTRAL" value="299"/>-->
    <!--<define name="MAG_Z_NEUTRAL" value="197"/>-->
    <!--<define name="MAG_X_SENS" value="7.25691459037" integer="16"/>-->
    <!--<define name="MAG_Y_SENS" value="7.7018409319" integer="16"/>-->
    <!--<define name="MAG_Z_SENS" value="8.16601148911" integer="16"/>-->

    <!--<define name= "MAG_X_CURRENT_COEF" value="0.001455"/>-->
    <!--<define name= "MAG_Y_CURRENT_COEF" value="0.012152"/>-->
    <!--<define name= "MAG_Z_CURRENT_COEF" value="-0.0001088"/>-->

    <!--Mag of gps-->
    <define name="MAG_X_NEUTRAL" value="21"/>
    <define name="MAG_Y_NEUTRAL" value="-206"/>
    <define name="MAG_Z_NEUTRAL" value="104"/>
    <define name="MAG_X_SENS" value="3.58153558634" integer="16"/>
    <define name="MAG_Y_SENS" value="3.58800117886" integer="16"/>
    <define name="MAG_Z_SENS" value="3.57182532939" integer="16"/>

	<define name="IMU_MPU9250_CHAN_X" value="0"/>
	<define name="IMU_MPU9250_CHAN_Y" value="1"/>
	<define name="IMU_MPU9250_CHAN_Z" value="2"/>
	<define name="IMU_MPU9250_X_SIGN" value="-1"/>
	<define name="IMU_MPU9250_Y_SIGN" value="-1"/>
	<define name="IMU_MPU9250_Z_SIGN" value="-1"/> <!-- was +1 -->


    <define name="BODY_TO_IMU_PHI"   value="0" unit="deg"/>
    <define name="BODY_TO_IMU_THETA" value="-93" unit="deg"/>
    <define name="BODY_TO_IMU_PSI"   value="180" unit="deg"/>
  </section>

  <section name="AUTOPILOT">
    <define name="MODE_MANUAL"  value="AP_MODE_ATTITUDE_DIRECT"/>
    <define name="MODE_AUTO1" value="AP_MODE_FORWARD"/>
    <define name="MODE_AUTO2"  value="AP_MODE_NAV"/>
    <define name="MODE_STARTUP"  value="AP_MODE_NAV"/>
  </section>

  <section name="BAT">
    <define name="MAX_BAT_CAPACITY" value="3300" unit="mAh"/>
    <define name="MILLIAMP_AT_IDLE_THROTTLE" value="280" unit="mA"/><!-- We substract ESC selfusage+AP+telemetry max-->
    <define name="MILLIAMP_AT_FULL_THROTTLE" value="3300" unit="mA"/><!--at max volts-->
    <define name="MAX_BAT_LEVEL" value="16.8" unit="V"/>
    <define name="LOW_BAT_LEVEL" value="14.0" unit="V"/>
    <define name="CRITIC_BAT_LEVEL" value="13.5" unit="V"/>
    <define name="CATASTROPHIC_BAT_LEVEL" value="13.2" unit="V"/>
  </section>

  <section name="STABILIZATION_ATTITUDE" prefix="STABILIZATION_ATTITUDE_">
    <!-- setpoints -->
    <define name="SP_MAX_PHI"     value="60." unit="deg"/>
    <define name="SP_MAX_THETA"   value="60." unit="deg"/>
    <define name="SP_MAX_R"       value="90." unit="deg/s"/>
    <define name="DEADBAND_R"     value="250"/>
    <define name="DEADBAND_A"     value="250"/>
    <define name="SP_PSI_DELTA_LIMIT" value="90" unit="deg"/>
  </section>


  <section name="STABILIZATION_ATTITUDE_INDI" prefix="STABILIZATION_INDI_">
    <!-- control effectiveness, scaled by INDI_G_SCALING (1000)-->
    <!-- Actuators					 tilt_l tilt_r  m_r  m_l						-->
    <define name="G1_ROLL" value="{0.0, 0.0, -15.2, 15.2, 0.0, 0.0}"/>
    <define name="G1_PITCH" value="{4.3, 4.3, 0.0, 0.0, -8.0, 8.0}"/>
    <define name="G1_YAW" value="{-2.631, 2.631, 0.0, 0.0, -2.0, -2.0}"/>
    <define name="G1_THRUST" value="{0.0, 0.0, -1.695, -1.695, 0.0, 0.0}"/>
    <!--Counter torque effect of spinning up a rotor-->
    <define name="G2" value="{0, 0, 0, 0, 0, 0}"/>

    <!-- reference acceleration for attitude control -->
    <define name="REF_ERR_P" value="80"/> <!-- 107 50.0 25.0 20-->
    <define name="REF_ERR_Q" value="40"/> <!-- was 80-->
    <define name="REF_ERR_R" value="80"/> <!-- was 100 200 20.0 65.0 20, increase from 60-->
    <define name="REF_RATE_P" value="9.0"/> <!--was 12 14.0 9.0 10-->
    <define name="REF_RATE_Q" value="6.0"/> <!-- was 12 15.0 14.0 10-->
    <define name="REF_RATE_R" value="9.0"/> <!-- was 14 15.0 10.0 10, increase from 12.5--> 

    <!--Maxium yaw rate, to avoid instability-->
    <define name="MAX_P" value="100.0" unit="deg/s"/>
    <define name="MAX_Q" value="100.0" unit="deg/s"/>
    <define name="MAX_R" value="100.0" unit="deg/s"/>

    <define name="ESTIMATION_FILT_CUTOFF" value="4.0"/>
    <define name="FILT_CUTOFF" value="1.0"/>
    <define name="FILT_CUTOFF_P" value="10.0"/>
    <define name="FILT_CUTOFF_Q" value="1.0"/>
    <define name="FILT_CUTOFF_R" value="10.0"/>

    <!-- first order actuator dynamics -->
     <define name="ACT_DYN" value="{0.0982, 0.0982, 0.045, 0.045, 0.0982, 0.0982}"/> <!-- [0.05 0.05 0.045 0.045] before -->
    <define name="ACT_RATE_LIMIT" value="{100, 100, 9600, 9600, 100, 100}"/>
    <define name="ACT_IS_SERVO" value="{1, 1, 0, 0, 1, 1}"/>

    <!-- Adaptive Learning Rate -->
    <define name="USE_ADAPTIVE" value="FALSE"/>
    <define name="ADAPTIVE_MU" value="0.0001"/>
    <define name="WLS_PRIORITIES" value="{1.0,1.0,1.0,1.0}"/>
    <define name="WLS_WU" value="{1.0,1.0,1.0,1.0,0.001,0.001}"/>

    <define name="MOMENT_INERTIA_RATIO" value="0.004478"/>	<!-- ratio between MoI of tilt vs. rest of drone [total MoI minus one tilt]. Both measure around axis of servo. -->
    <define name="GRADIENT" value="0.0001"/>				<!-- gradient in linear relationship between pprz and angle (in rad), must be same as in 'ctrl_effectiveness_calc.c' -->

    <!-- Minimum throttle that can be assign to motors -->
	  <define name="MIN_THROTTLE" value="2000"/> <!-- 2500 before -->
	  <define name="MIN_THROTTLE_FWD" value="1500"/>

	  <!-- Maximum servo increment in PPRZ units -->
	  <define name="MAX_SERVO_INCREMENT" value="4500"/>
	
	  <define name="PIVOT_GAIN_Q" value="100"/>
	  <define name="PIVOT_GAIN_THETA" value="0.1"/>
    <define name="PIVOT_SERVOGAIN_Q" value="0.1"/>
    <define name="PIVOT_SERVOGAIN_THETA" value="0.1"/>
    <define name="PIVOT_Q" value="25"/>
    <define name="PIVOT_THETA" value="100"/>
    </section>

<!-- Definitions for control effectiveness calculator module -->
  <section name="CONTROL_EFFECTIVENESS" prefix="CTRL_EFF_CALC_">
  	<define name="GROUND_CONTACT" value="0"/>
  	
        <!-- Drone specific metrics -->
    	<define name="MASS" value="0.3756"/>		<!--[kg]-->
    	<define name="I_XX" value="0.00526"/>	<!--[kg m2] The cyclone value from jsbsim is 0.017897, currently using values from CAD files -->
    	<!--<define name="I_YY" value="0.04914925"/>-->	<!--[kg m2] The cyclone value from jsbsim is 0.003390, currently using values from CAD files -->
    	<define name="I_YY" value="0.0011"/>
    	<define name="I_ZZ" value="0.00341"/>	<!--[kg m2] The cyclone value from jsbsim is 0.020337, currently using values from CAD files -->
 	    <!--<define name="I_XX" value="0.017897"/>	[kg m2] The cyclone value from jsbsim is 0.017897, currently using values from CAD files -->
    	<!--<define name="I_YY" value="0.003390"/>	[kg m2] The cyclone value from jsbsim is 0.003390, currently using values from CAD files -->
    	<!--<define name="I_ZZ" value="0.020337"/>	[kg m2] The cyclone value from jsbsim is 0.020337, currently using values from CAD files -->

        <!-- Motor coefficients. Thrust as a function of ESC command (on range [0, 9600])
    	 	 Thrust equation of the form: T = k1 x^2 + k2 x + k3 -->
    	<define name="K1" value="0.00000005"/>
    	<define name="K2" value="0.0003"/>
    	<define name="K3" value="0.1486"/>
    	
      <define name="PITCH_A" value="0.008"/>
      <define name="PITCH_B" value="0.02"/>

      <define name="YAW_A" value="0.0002"/>
      <define name="YAW_B" value="0.02"/>

    	<!-- Location of the Motors w.r.t. the c.g. -->
    	<define name="Y_DIST" value="0.16"/>		<!--[m]-->
    	<define name="Z_DIST" value="0.075"/>	<!--[m]-->

      <define name="MAPPING" value="0.00009"/>	<!--This the is mapping of PPRZ units to rads for the servos -->
  </section>
  <!-- Gains for vertical navigation -->
  <section name="GUIDANCE_V" prefix="GUIDANCE_V_">
    <define name="HOVER_KP"    value="200"/>
    <define name="HOVER_KD"    value="175"/>
    <define name="HOVER_KI"    value="72"/>
    <define name="NOMINAL_HOVER_THROTTLE" value ="0.5"/>
    <define name="ADAPT_THROTTLE_ENABLED" value="FALSE"/>
  </section>

  <section name="NAV">
    <define name="NAV_CLIMB_VSPEED" value="1.0"/>
    <define name="NAV_DESCEND_VSPEED" value="-0.8"/>
  </section>

  <!--<section name="AHRS" prefix="AHRS_">-->
    <!--<define name="H_X" value="0.5138"/>-->
    <!--<define name="H_Y" value="0.00019"/>-->
    <!--<define name="H_Z" value="0.8578"/>-->
    <!--<define name="GRAVITY_HEURISTIC_FACTOR" value="0"/>-->
  <!--</section>-->

  <section name="INS" prefix="INS_">
    <!-- Delft -->
    <define name="H_X" value="0.3928"/>
    <define name="H_Y" value="-0.0140"/>
    <define name="H_Z" value="0.9195"/>
  </section>

  <!-- Gains for horizontal navigation-->
  <section name="GUIDANCE_H" prefix="GUIDANCE_H_">
    <define name="PGAIN" value="100"/>
    <define name="DGAIN" value="100"/>
    <define name="IGAIN" value="20"/>
  </section>

  <section name="MISC">
    <!--The Quadshot uses (when TRUE) a slightly different axis system for the setpoint, to make both hovering and flying forward intuitive-->
    <define name="USE_EARTH_BOUND_RC_SETPOINT" value="TRUE"/>
    <!-- This is the pitch angle that the Quadshot will have in forward flight, where 0 degrees is hover-->
    <define name="TRANSITION_MAX_OFFSET" value="-75.0" unit="deg"/>
    <define name="NO_RC_THRUST_LIMIT" value="TRUE"/>
    <define name="COORDINATED_TURN_AIRSPEED" value="12.0"/>   <!--2 before-->

    <define name="BARO_PERIODIC_FREQUENCY" value="50"/>
    <define name="GUIDANCE_H_MAX_BANK" value="60" unit="deg"/>

    <define name="FWD_SIDESLIP_GAIN" value="0.32"/>
    <!--<define name="SIDESLIP_YAW_GAIN" value="0.32"/>-->

    <!--<define name="EFF_SCHED_USE_FUNCTION" value="TRUE"/>-->

    <define name="ARRIVED_AT_WAYPOINT" value="5.0"/>
    <define name="USE_AIRSPEED" value="TRUE"/>
    <define name="USE_PIVOT_SWITCH" value="TRUE"/>
  </section>

  <section name="SIMULATOR" prefix="NPS_">
    <define name="ACTUATOR_NAMES" value="tilt_left, tilt_right, mot_right, mot_left, ele_left, ele_right" type="string[]"/>
    <define name="JSBSIM_MODEL" value="tilt_tailsitter" type="string"/>
    <define name="SENSORS_PARAMS" value="nps_sensors_params_default.h" type="string"/>
    <define name="NO_MOTOR_MIXING" value="TRUE"/>
  </section>

</airframe>

    	
